<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    
    <title>Keuangan Keluarga MasDar</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                    }
                }
            }
        }
    </script>

    <!-- External Libs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .fab-shadow {
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.5);
        }
        /* Smooth transitions */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-gradient {
            background: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%);
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[100] w-full max-w-xs space-y-2 pointer-events-none"></div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 z-[90] flex items-center justify-center hidden backdrop-blur-sm">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            <p class="mt-4 text-sm font-medium text-slate-500">Memuat data...</p>
        </div>
    </div>

    <!-- AUTH SECTION (Login/Register/Family) -->
    <div id="auth-section" class="flex-1 flex items-center justify-center p-6 bg-slate-50">
        <div class="w-full max-w-md bg-white rounded-3xl shadow-xl p-8 fade-in border border-slate-100">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-indigo-50 text-indigo-600 mb-4">
                    <i class="fa-solid fa-wallet text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-900">Keuangan Keluarga</h1>
                <p class="text-slate-500 text-sm mt-2">Kelola finansial rumah tangga lebih rapi.</p>
            </div>

            <!-- Login/Register Form -->
            <div id="auth-forms">
                <div class="space-y-4">
                    <button onclick="handleAuthAction('login')" class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl transition-all shadow-lg shadow-indigo-200">
                        Masuk dengan Google / Anonim
                    </button>
                    <!-- Fallback mechanism logic happens in JS -->
                </div>
            </div>

            <!-- Family Setup (Hidden by default) -->
            <div id="family-setup" class="hidden space-y-6">
                <div class="text-center">
                    <h3 class="font-bold text-lg">Bergabung atau Buat Keluarga</h3>
                    <p class="text-xs text-slate-400">Anda belum terhubung dengan keluarga manapun.</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="showModal('create-family-modal')" class="p-4 border-2 border-dashed border-indigo-200 rounded-2xl flex flex-col items-center justify-center gap-3 hover:bg-indigo-50 hover:border-indigo-400 transition-colors">
                        <i class="fa-solid fa-plus-circle text-2xl text-indigo-500"></i>
                        <span class="text-sm font-medium">Buat Baru</span>
                    </button>
                    <button onclick="showModal('join-family-modal')" class="p-4 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center gap-3 hover:bg-slate-50 hover:border-slate-400 transition-colors">
                        <i class="fa-solid fa-users text-2xl text-slate-500"></i>
                        <span class="text-sm font-medium">Gabung</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP SECTION -->
    <div id="app-section" class="hidden flex flex-col h-full bg-slate-50">
        
        <!-- Header -->
        <header class="bg-white px-6 py-4 flex justify-between items-center shadow-sm z-10 sticky top-0">
            <div>
                <h2 class="text-xs font-bold text-indigo-600 uppercase tracking-wider">Keluarga</h2>
                <h1 id="header-family-name" class="text-lg font-bold text-slate-800 leading-tight">Nama Keluarga</h1>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="exportToPDF()" class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-200 transition-colors" title="Download Laporan">
                    <i class="fa-solid fa-file-pdf"></i>
                </button>
                <div class="relative group">
                    <button class="w-9 h-9 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-sm border-2 border-white shadow-sm">
                        <span id="user-initial">U</span>
                    </button>
                    <!-- Dropdown -->
                    <div class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg py-1 hidden group-hover:block border border-slate-100">
                         <div class="px-4 py-2 border-b border-slate-100">
                             <p class="text-xs text-slate-500">Kode Keluarga:</p>
                             <p id="header-family-code" class="font-mono font-bold text-sm select-all cursor-pointer" onclick="copyFamilyCode()">CODE123</p>
                         </div>
                         <button onclick="handleLogout()" class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-red-50">
                             <i class="fa-solid fa-arrow-right-from-bracket mr-2"></i> Keluar
                         </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Area (Scrollable) -->
        <main class="flex-1 overflow-y-auto overflow-x-hidden p-6 pb-24 space-y-6 hide-scrollbar">
            
            <!-- Views container -->
            <div id="view-dashboard" class="space-y-6 fade-in">
                
                <!-- Balance Card -->
                <div class="card-gradient rounded-3xl p-6 text-white shadow-xl shadow-indigo-200 relative overflow-hidden">
                    <!-- Background Pattern -->
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
                    <div class="absolute bottom-0 left-0 -mb-4 -ml-4 w-32 h-32 bg-indigo-900 opacity-10 rounded-full blur-xl"></div>
                    
                    <p class="text-indigo-100 text-sm font-medium mb-1">Total Saldo</p>
                    <h2 id="total-balance" class="text-3xl font-bold mb-6">Rp 0</h2>
                    
                    <div class="grid grid-cols-2 gap-4 border-t border-white/20 pt-4">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <div class="w-5 h-5 rounded-full bg-emerald-400/20 flex items-center justify-center">
                                    <i class="fa-solid fa-arrow-down text-[10px] text-emerald-300"></i>
                                </div>
                                <span class="text-xs text-indigo-100">Pemasukan</span>
                            </div>
                            <p id="total-income" class="font-semibold text-lg">Rp 0</p>
                        </div>
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <div class="w-5 h-5 rounded-full bg-rose-400/20 flex items-center justify-center">
                                    <i class="fa-solid fa-arrow-up text-[10px] text-rose-300"></i>
                                </div>
                                <span class="text-xs text-indigo-100">Pengeluaran</span>
                            </div>
                            <p id="total-expense" class="font-semibold text-lg">Rp 0</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div>
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-bold text-slate-800 text-lg">Transaksi Terakhir</h3>
                        <button onclick="switchTab('history')" class="text-xs text-indigo-600 font-medium hover:underline">Lihat Semua</button>
                    </div>
                    
                    <div id="recent-transactions-list" class="space-y-3">
                        <!-- Dynamic Content -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 text-center py-8">
                            <i class="fa-solid fa-receipt text-slate-300 text-3xl mb-2"></i>
                            <p class="text-slate-400 text-sm">Belum ada transaksi</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-analytics" class="hidden fade-in space-y-6">
                <h3 class="font-bold text-slate-800 text-xl">Analisis Pengeluaran</h3>
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <canvas id="expenseChart" width="400" height="400"></canvas>
                </div>

                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                    <h4 class="font-bold text-indigo-900 mb-2">Insight</h4>
                    <p id="analytics-insight" class="text-sm text-indigo-700">Data belum cukup untuk memberikan analisis.</p>
                </div>
            </div>

            <div id="view-history" class="hidden fade-in space-y-4">
                 <h3 class="font-bold text-slate-800 text-xl mb-4">Riwayat Transaksi</h3>
                 
                 <!-- Filter placeholder -->
                 <div class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                     <button class="px-4 py-1.5 rounded-full bg-indigo-600 text-white text-xs font-medium whitespace-nowrap">Semua</button>
                     <button class="px-4 py-1.5 rounded-full bg-white border border-slate-200 text-slate-600 text-xs font-medium whitespace-nowrap">Pemasukan</button>
                     <button class="px-4 py-1.5 rounded-full bg-white border border-slate-200 text-slate-600 text-xs font-medium whitespace-nowrap">Pengeluaran</button>
                 </div>

                 <div id="full-history-list" class="space-y-3">
                     <!-- Populated by JS -->
                 </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="bg-white border-t border-slate-200 px-6 py-3 flex justify-between items-center z-40 pb-safe">
            <button onclick="switchTab('dashboard')" class="nav-btn active flex-1 flex flex-col items-center gap-1 text-indigo-600">
                <i class="fa-solid fa-house text-xl"></i>
                <span class="text-[10px] font-medium">Beranda</span>
            </button>
            <button onclick="switchTab('history')" class="nav-btn flex-1 flex flex-col items-center gap-1 text-slate-400 hover:text-indigo-600 transition-colors">
                <i class="fa-solid fa-list text-xl"></i>
                <span class="text-[10px] font-medium">Riwayat</span>
            </button>
            
            <!-- FAB (Floating Action Button) -->
            <div class="relative -top-8">
                <button onclick="openTransactionModal()" class="w-14 h-14 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-lg hover:bg-indigo-700 transition-transform hover:scale-105 active:scale-95 fab-shadow">
                    <i class="fa-solid fa-plus text-2xl"></i>
                </button>
            </div>

            <button onclick="switchTab('analytics')" class="nav-btn flex-1 flex flex-col items-center gap-1 text-slate-400 hover:text-indigo-600 transition-colors">
                <i class="fa-solid fa-chart-pie text-xl"></i>
                <span class="text-[10px] font-medium">Analisis</span>
            </button>
            <button onclick="showToast('Fitur Profil akan segera hadir!', 'info')" class="nav-btn flex-1 flex flex-col items-center gap-1 text-slate-400 hover:text-indigo-600 transition-colors">
                <i class="fa-solid fa-user text-xl"></i>
                <span class="text-[10px] font-medium">Profil</span>
            </button>
        </nav>
    </div>

    <!-- MODALS -->

    <!-- Create Family Modal -->
    <div id="create-family-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl transform scale-100 transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-slate-800">Buat Keluarga Baru</h3>
                <button onclick="closeModal('create-family-modal')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <form onsubmit="submitCreateFamily(event)">
                <div class="mb-5">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Nama Keluarga</label>
                    <input type="text" id="new-family-name" placeholder="Contoh: Keluarga Cemara" required class="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                </div>
                <button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl active:bg-indigo-800 shadow-lg shadow-indigo-200">Buat Sekarang</button>
            </form>
        </div>
    </div>

    <!-- Join Family Modal -->
    <div id="join-family-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-slate-800">Gabung Keluarga</h3>
                <button onclick="closeModal('join-family-modal')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <form onsubmit="submitJoinFamily(event)">
                <div class="mb-5">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Kode Keluarga</label>
                    <input type="text" id="join-family-code" placeholder="Masukkan Kode Unik" required class="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all uppercase tracking-widest font-mono">
                    <p class="text-xs text-slate-500 mt-2">Minta kode ini dari admin keluarga Anda.</p>
                </div>
                <button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl active:bg-indigo-800 shadow-lg shadow-indigo-200">Gabung</button>
            </form>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="transaction-modal" class="hidden fixed inset-0 z-[60] bg-slate-900/60 backdrop-blur-sm flex items-end sm:items-center justify-center sm:p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[90vh] sm:h-auto overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-slate-800">Catat Transaksi</h3>
                <button onclick="closeModal('transaction-modal')" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <form onsubmit="submitTransaction(event)" class="space-y-5">
                <!-- Type Toggle -->
                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <button type="button" onclick="setTransactionType('income')" id="btn-income" class="flex-1 py-3 rounded-lg text-sm font-semibold transition-all text-slate-500 hover:text-slate-700">Pemasukan</button>
                    <button type="button" onclick="setTransactionType('expense')" id="btn-expense" class="flex-1 py-3 rounded-lg text-sm font-semibold transition-all bg-white shadow-sm text-rose-600 border border-slate-200">Pengeluaran</button>
                </div>
                <input type="hidden" id="trx-type" value="expense">

                <!-- Amount -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Jumlah (Rp)</label>
                    <input type="number" id="trx-amount" placeholder="0" required class="w-full text-3xl font-bold text-slate-800 border-b-2 border-slate-200 pb-2 focus:outline-none focus:border-indigo-600 bg-transparent placeholder-slate-300">
                </div>

                <!-- Date -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Tanggal</label>
                    <input type="date" id="trx-date" required class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm">
                </div>

                <!-- Category -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Kategori</label>
                    <select id="trx-category" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm appearance-none cursor-pointer">
                        <option value="Makan">üçΩÔ∏è Makanan & Minuman</option>
                        <option value="Belanja">üõí Belanja Bulanan</option>
                        <option value="Transport">üöó Transportasi</option>
                        <option value="Tagihan">üí° Tagihan & Utilitas</option>
                        <option value="Hiburan">üé¨ Hiburan</option>
                        <option value="Kesehatan">üíä Kesehatan</option>
                        <option value="Pendidikan">üìö Pendidikan</option>
                        <option value="Lainnya">üì¶ Lainnya</option>
                    </select>
                </div>

                <!-- Note -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Catatan (Opsional)</label>
                    <textarea id="trx-note" rows="2" placeholder="Detail transaksi..." class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>

                <button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl active:bg-indigo-800 shadow-lg shadow-indigo-200 mt-4">Simpan Transaksi</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc, onSnapshot, query, orderBy, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = JSON.parse(localStorage.getItem('firebaseConfig') || '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'family-finance-app';
        
        // Placeholder for initial setup if config is missing (In this environment it's handled automatically usually)
        if (!firebaseConfig.apiKey) {
            // Using a dummy init for UI demo if environment variables aren't set
            // In a real scenario, this would break, but here we assume the environment injects it
             console.log("Environment Config Check: Pending");
        }

        const app = initializeApp(JSON.parse(__firebase_config));
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE VARIABLES
        let currentUser = null;
        let currentFamilyId = null;
        let transactions = [];
        let expenseChart = null;

        // --- AUTH & INITIALIZATION ---
        
        window.handleAuthAction = async (action) => {
            showLoading(true);
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error(error);
                showToast("Gagal masuk: " + error.message, 'error');
                showLoading(false);
            }
        };

        window.handleLogout = async () => {
             await signOut(auth);
             location.reload();
        }

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                // Check if user has a family
                // Storing user-family mapping in user's private doc for simplicity in this constrained env
                const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
                const userDoc = await getDoc(userDocRef);

                showLoading(false);

                if (userDoc.exists() && userDoc.data().familyId) {
                    currentFamilyId = userDoc.data().familyId;
                    initApp(currentFamilyId);
                } else {
                    document.getElementById('auth-forms').classList.add('hidden');
                    document.getElementById('family-setup').classList.remove('hidden');
                }
            } else {
                showLoading(false);
                // Reset UI to login
            }
        });

        // --- FAMILY LOGIC ---

        window.submitCreateFamily = async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-family-name').value.trim();
            if(!name) return;

            showLoading(true);
            try {
                // Generate simple family ID (random 6 chars)
                const familyId = Math.random().toString(36).substring(2, 8).toUpperCase();
                
                // Save Family Data (Public path so it can be shared)
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'families', familyId), {
                    name: name,
                    createdAt: serverTimestamp(),
                    members: [currentUser.uid]
                });

                // Link User to Family
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), {
                    familyId: familyId,
                    role: 'admin'
                });

                currentFamilyId = familyId;
                closeModal('create-family-modal');
                initApp(familyId);
            } catch (err) {
                showToast(err.message, 'error');
                showLoading(false);
            }
        };

        window.submitJoinFamily = async (e) => {
            e.preventDefault();
            const code = document.getElementById('join-family-code').value.trim().toUpperCase();
            if(!code) return;

            showLoading(true);
            try {
                const familyRef = doc(db, 'artifacts', appId, 'public', 'data', 'families', code);
                const familySnap = await getDoc(familyRef);

                if (familySnap.exists()) {
                     // Link User
                    await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), {
                        familyId: code,
                        role: 'member'
                    });
                    
                    currentFamilyId = code;
                    closeModal('join-family-modal');
                    initApp(code);
                } else {
                    showToast("Kode Keluarga tidak ditemukan!", 'error');
                    showLoading(false);
                }
            } catch (err) {
                showToast(err.message, 'error');
                showLoading(false);
            }
        };

        // --- APP INITIALIZATION ---

        function initApp(familyId) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('flex'); // Ensure flex is added
            
            // Set User Initial
            document.getElementById('user-initial').textContent = currentUser.uid.substring(0,1).toUpperCase();
            document.getElementById('header-family-code').textContent = familyId;

            // Listen to Family Details
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'families', familyId), (doc) => {
                if(doc.exists()) {
                    document.getElementById('header-family-name').textContent = doc.data().name;
                }
            });

            // Listen to Transactions
            const trxRef = collection(db, 'artifacts', appId, 'public', 'data', 'families', familyId, 'transactions');
            // Note: Composite index might be needed for orderBy('date', 'desc'), if fails use memory sort
            const q = query(trxRef); 

            onSnapshot(q, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Sort in memory to avoid Firestore index requirement issues in this environment
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                updateDashboard();
                renderTransactions();
                updateChart();
                showLoading(false);
            }, (error) => {
                console.error(error);
                showToast("Gagal memuat transaksi", 'error');
            });
        }

        // --- TRANSACTION LOGIC ---

        window.submitTransaction = async (e) => {
            e.preventDefault();
            
            const type = document.getElementById('trx-type').value;
            const amount = parseFloat(document.getElementById('trx-amount').value);
            const date = document.getElementById('trx-date').value;
            const category = document.getElementById('trx-category').value;
            const note = document.getElementById('trx-note').value;

            if (!amount || !date) {
                showToast("Mohon lengkapi data", 'error');
                return;
            }

            closeModal('transaction-modal');
            showLoading(true);

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'families', currentFamilyId, 'transactions'), {
                    type,
                    amount,
                    date,
                    category,
                    note,
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                
                // Reset form
                e.target.reset();
                document.getElementById('trx-date').valueAsDate = new Date();
                showToast("Transaksi berhasil disimpan!", 'success');
            } catch (err) {
                showToast("Gagal menyimpan: " + err.message, 'error');
            } finally {
                showLoading(false);
            }
        };

        window.deleteTransaction = async (id) => {
            if(!confirm("Hapus transaksi ini?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'families', currentFamilyId, 'transactions', id));
                showToast("Transaksi dihapus", 'success');
            } catch(err) {
                showToast("Gagal menghapus", 'error');
            }
        }

        // --- UI UPDATES ---

        function updateDashboard() {
            let income = 0;
            let expense = 0;

            transactions.forEach(t => {
                if (t.type === 'income') income += t.amount;
                else expense += t.amount;
            });

            const balance = income - expense;

            document.getElementById('total-balance').textContent = formatRupiah(balance);
            document.getElementById('total-income').textContent = formatRupiah(income);
            document.getElementById('total-expense').textContent = formatRupiah(expense);
        }

        function renderTransactions() {
            const recentContainer = document.getElementById('recent-transactions-list');
            const historyContainer = document.getElementById('full-history-list');
            
            recentContainer.innerHTML = '';
            historyContainer.innerHTML = '';

            if (transactions.length === 0) {
                const emptyHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-100 text-center">
                        <i class="fa-solid fa-receipt text-slate-300 text-4xl mb-3"></i>
                        <p class="text-slate-400 text-sm">Belum ada transaksi tercatat.</p>
                    </div>`;
                recentContainer.innerHTML = emptyHTML;
                historyContainer.innerHTML = emptyHTML;
                return;
            }

            transactions.forEach((t, index) => {
                const isExpense = t.type === 'expense';
                const colorClass = isExpense ? 'text-rose-600' : 'text-emerald-600';
                const iconBg = isExpense ? 'bg-rose-50' : 'bg-emerald-50';
                const iconColor = isExpense ? 'text-rose-500' : 'text-emerald-500';
                const sign = isExpense ? '-' : '+';
                
                // Icon mapping
                let iconClass = 'fa-tag';
                if(t.category === 'Makan') iconClass = 'fa-utensils';
                else if(t.category === 'Belanja') iconClass = 'fa-cart-shopping';
                else if(t.category === 'Transport') iconClass = 'fa-car';
                else if(t.category === 'Tagihan') iconClass = 'fa-bolt';
                else if(t.category === 'Hiburan') iconClass = 'fa-film';
                else if(t.category === 'Kesehatan') iconClass = 'fa-heart-pulse';
                else if(t.category === 'Pendidikan') iconClass = 'fa-book';

                const html = `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between group hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full ${iconBg} flex items-center justify-center ${iconColor}">
                                <i class="fa-solid ${iconClass} text-lg"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm">${t.category}</h4>
                                <p class="text-xs text-slate-400">${formatDate(t.date)} ${t.note ? '‚Ä¢ ' + t.note : ''}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${colorClass}">${sign} ${formatCompactRupiah(t.amount)}</p>
                            <button onclick="deleteTransaction('${t.id}')" class="text-xs text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;

                // Add to history
                historyContainer.insertAdjacentHTML('beforeend', html);
                
                // Add first 5 to recent
                if(index < 5) {
                    recentContainer.insertAdjacentHTML('beforeend', html);
                }
            });
        }

        function updateChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            // Group expenses by category
            const categories = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                categories[t.category] = (categories[t.category] || 0) + t.amount;
            });

            const labels = Object.keys(categories);
            const data = Object.values(categories);
            
            // Determine highest expense
            let highestCategory = 'Tidak ada';
            let maxVal = 0;
            labels.forEach((l, i) => {
                if(data[i] > maxVal) {
                    maxVal = data[i];
                    highestCategory = l;
                }
            });
            
            if(maxVal > 0) {
                document.getElementById('analytics-insight').textContent = `Pengeluaran terbesar Anda bulan ini adalah di kategori ${highestCategory} (${formatCompactRupiah(maxVal)}).`;
            }

            if (expenseChart) expenseChart.destroy();

            if (labels.length === 0) {
                 // Empty state for chart handled by UI context or leave empty
                 return;
            }

            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#4f46e5', '#ec4899', '#f59e0b', '#10b981', '#6366f1', '#8b5cf6', '#14b8a6', '#f43f5e'
                        ],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- UTILITIES ---

        window.formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        }

        window.formatCompactRupiah = (number) => {
             // For mobile view, abbreviate large numbers
            return new Intl.NumberFormat('id-ID', { notation: "compact", compactDisplay: "short", style: 'currency', currency: 'IDR' }).format(number);
        }

        window.formatDate = (dateString) => {
            const options = { day: 'numeric', month: 'short' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        window.showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let bgClass = 'bg-slate-800';
            let icon = 'fa-info-circle';

            if(type === 'success') { bgClass = 'bg-emerald-600'; icon = 'fa-check-circle'; }
            if(type === 'error') { bgClass = 'bg-rose-600'; icon = 'fa-exclamation-circle'; }

            toast.className = `${bgClass} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 text-sm pointer-events-auto transform transition-all duration-300 translate-y-[-20px] opacity-0`;
            toast.innerHTML = `<i class="fa-solid ${icon}"></i> <span>${message}</span>`;
            
            container.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-y-[-20px]', 'opacity-0');
            }, 10);

            // Remove after 3s
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-[-10px]');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        window.showLoading = (show) => {
            const overlay = document.getElementById('loading-overlay');
            if(show) overlay.classList.remove('hidden');
            else overlay.classList.add('hidden');
        }

        // --- UI INTERACTION ---

        window.switchTab = (tabId) => {
            // Hide all views
            ['dashboard', 'history', 'analytics'].forEach(id => {
                document.getElementById(`view-${id}`).classList.add('hidden');
            });
            // Show selected
            document.getElementById(`view-${tabId}`).classList.remove('hidden');

            // Update Nav state
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-indigo-600', 'active');
                btn.classList.add('text-slate-400');
            });
            
            // Ideally we'd select by ID, here we rely on order or click event context
            // Simplistic toggle back for "active" class on the clicked element if called via click
            // Since this function is called by onclick attributes, we handle visual state slightly manually
            const activeBtn = event.currentTarget;
            if(activeBtn && activeBtn.classList.contains('nav-btn')) {
                activeBtn.classList.remove('text-slate-400');
                activeBtn.classList.add('text-indigo-600');
            }
        };

        window.showModal = (id) => {
            document.getElementById(id).classList.remove('hidden');
        }

        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
        }

        window.openTransactionModal = () => {
            document.getElementById('trx-date').valueAsDate = new Date();
            showModal('transaction-modal');
        }

        window.setTransactionType = (type) => {
            document.getElementById('trx-type').value = type;
            const btnIncome = document.getElementById('btn-income');
            const btnExpense = document.getElementById('btn-expense');

            if (type === 'income') {
                btnIncome.classList.remove('text-slate-500');
                btnIncome.classList.add('bg-white', 'shadow-sm', 'text-emerald-600', 'border', 'border-slate-200');
                
                btnExpense.classList.add('text-slate-500');
                btnExpense.classList.remove('bg-white', 'shadow-sm', 'text-rose-600', 'border', 'border-slate-200');
            } else {
                btnExpense.classList.remove('text-slate-500');
                btnExpense.classList.add('bg-white', 'shadow-sm', 'text-rose-600', 'border', 'border-slate-200');
                
                btnIncome.classList.add('text-slate-500');
                btnIncome.classList.remove('bg-white', 'shadow-sm', 'text-emerald-600', 'border', 'border-slate-200');
            }
        }

        window.copyFamilyCode = () => {
            const code = document.getElementById('header-family-code').textContent;
            navigator.clipboard.writeText(code);
            showToast("Kode disalin ke clipboard!", 'success');
        }

        window.exportToPDF = () => {
            showToast("Sedang membuat PDF...", "info");
            const element = document.getElementById('view-history');
            const originalClass = element.className;
            
            // Temporarily make visible and style for print
            element.classList.remove('hidden');
            
            const opt = {
                margin:       10,
                filename:     `Laporan_Keuangan_${currentFamilyId}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                showToast("PDF Berhasil diunduh", 'success');
                // Revert UI state logic would be needed here if not already on history tab
                // But for simplicity, we assume user stays on page.
                if(document.querySelector('.nav-btn.text-indigo-600').onclick.toString().includes('dashboard')) {
                     element.classList.add('hidden');
                }
            });
        }
        
        // Initialize default UI state
        setTransactionType('expense');

    </script>
</body>
</html>

