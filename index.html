import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken,
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  onSnapshot 
} from 'firebase/firestore';
import { 
  LayoutDashboard, 
  UtensilsCrossed, 
  Users, 
  Wallet, 
  Save, 
  TrendingUp, 
  Plus, 
  Trash2, 
  Loader2, 
  ChefHat,
  MoreHorizontal,
  Store
} from 'lucide-react';

// --- KONFIGURASI FIREBASE (Sama) ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- UTILITIES ---
const formatIDR = (num) => {
  if (Math.abs(num) >= 1000000000) {
    return (num / 1000000000).toFixed(1) + ' M';
  }
  if (Math.abs(num) >= 1000000) {
    return (num / 1000000).toFixed(1) + ' Jt';
  }
  return new Intl.NumberFormat('id-ID', { 
    style: 'currency', 
    currency: 'IDR', 
    maximumFractionDigits: 0 
  }).format(num);
};

const formatPercent = (num) => `${(num * 100).toFixed(1)}%`;

// --- DEFAULT STATE ---
const INITIAL_DATA = {
  profile: { name: '', tagline: '', address: '', taxRate: 0.1 },
  menuItems: [
    { id: 1, name: 'Kopi Susu', price: 18000, cogs: 8000, targetQty: 50 },
    { id: 2, name: 'Nasi Goreng', price: 25000, cogs: 12000, targetQty: 30 }
  ],
  staff: [
    { id: 1, role: 'Koki Utama', salary: 4500000, count: 1 },
    { id: 2, role: 'Pelayan', salary: 2000000, count: 2 }
  ],
  capex: [
    { id: 1, item: 'Sewa Ruko', cost: 30000000 },
    { id: 2, item: 'Renovasi', cost: 15000000 }
  ],
  opex: [
    { id: 1, item: 'Listrik/Air', cost: 1000000 },
    { id: 2, item: 'Iklan Medsos', cost: 500000 }
  ]
};

export default function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('dash');
  const [data, setData] = useState(INITIAL_DATA);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [unsaved, setUnsaved] = useState(false);

  // --- AUTH & SYNC ---
  useEffect(() => {
    const init = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    init();
    return onAuthStateChanged(auth, setUser);
  }, []);

  useEffect(() => {
    if (!user) return;
    const unsub = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'business_data', 'pro_plan'), (s) => {
      if (s.exists()) setData(p => ({ ...p, ...s.data() }));
      setLoading(false);
    });
    return () => unsub();
  }, [user]);

  // --- CALCULATIONS ---
  const metrics = useMemo(() => {
    const DAYS = 26;
    let dRev = 0, dCOGS = 0;
    data.menuItems.forEach(i => {
      dRev += (i.price * i.targetQty);
      dCOGS += (i.cogs * i.targetQty);
    });
    const mRev = dRev * DAYS;
    const mCOGS = dCOGS * DAYS;
    const gross = mRev - mCOGS;
    
    const staffCost = data.staff.reduce((a, c) => a + (c.salary * c.count), 0);
    const opexFixed = data.opex.reduce((a, c) => a + c.cost, 0);
    const expense = staffCost + opexFixed;
    
    const ebitda = gross - expense;
    const tax = ebitda > 0 ? ebitda * data.profile.taxRate : 0;
    const net = ebitda - tax;
    
    const invest = data.capex.reduce((a, c) => a + c.cost, 0);
    const bep = net > 0 ? invest / net : 0;

    return { mRev, net, invest, bep, mCOGS, expense };
  }, [data]);

  // --- HANDLERS ---
  const handleSave = async () => {
    if (!user) return;
    setSaving(true);
    try {
      await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'business_data', 'pro_plan'), data);
      setUnsaved(false);
    } catch (e) { console.error(e); }
    setSaving(false);
  };

  const update = (sec, val) => { setData(p => ({ ...p, [sec]: val })); setUnsaved(true); };
  const updateArr = (sec, id, f, v) => update(sec, data[sec].map(i => i.id === id ? { ...i, [f]: v } : i));
  const add = (sec, tpl) => update(sec, [...data[sec], { ...tpl, id: Date.now() }]);
  const del = (sec, id) => update(sec, data[sec].filter(i => i.id !== id));

  if (loading) return <div className="h-screen flex flex-col items-center justify-center bg-slate-50 text-slate-400 gap-2"><Loader2 className="animate-spin" /><span>Memuat Aplikasi...</span></div>;

  return (
    <div className="flex flex-col h-screen bg-slate-100 font-sans text-slate-800">
      
      {/* STICKY HEADER */}
      <header className="bg-white px-4 py-3 shadow-sm flex justify-between items-center sticky top-0 z-20">
        <div className="flex items-center gap-2">
          <div className="bg-orange-500 p-1.5 rounded-lg">
            <ChefHat className="w-5 h-5 text-white" />
          </div>
          <div>
            <h1 className="font-bold text-sm leading-tight">BizPlan Mobile</h1>
            <p className="text-[10px] text-slate-400">{data.profile.name || 'Rencana Usaha'}</p>
          </div>
        </div>
        <button 
          onClick={handleSave}
          disabled={saving || !unsaved}
          className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition-all ${
            unsaved ? 'bg-orange-600 text-white shadow-md shadow-orange-200' : 'bg-slate-100 text-slate-400'
          }`}
        >
          {saving ? <Loader2 className="w-3 h-3 animate-spin" /> : <Save className="w-3 h-3" />}
          {saving ? 'Saving' : 'Simpan'}
        </button>
      </header>

      {/* SCROLLABLE CONTENT */}
      <main className="flex-1 overflow-y-auto pb-24 p-4">
        
        {activeTab === 'dash' && (
          <div className="space-y-4 animate-fade-in">
            {/* Quick Stats Grid */}
            <div className="grid grid-cols-2 gap-3">
              <StatCard label="Omzet / Bulan" val={formatIDR(metrics.mRev)} icon={TrendingUp} color="blue" />
              <StatCard label="Laba Bersih" val={formatIDR(metrics.net)} icon={Wallet} color={metrics.net > 0 ? "green" : "red"} />
            </div>

            {/* Health Card */}
            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
              <div className="flex justify-between items-center mb-3">
                <h3 className="font-bold text-sm text-slate-700">Kesehatan Bisnis</h3>
                <span className={`px-2 py-1 rounded-md text-[10px] font-bold uppercase ${metrics.bep > 0 && metrics.bep < 18 ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                  {metrics.bep > 0 && metrics.bep < 18 ? 'Sehat' : 'Perlu Cek'}
                </span>
              </div>
              <div className="space-y-3">
                 <HealthRow label="Modal Awal" val={formatIDR(metrics.invest)} />
                 <HealthRow label="Balik Modal (BEP)" val={metrics.bep > 0 ? `${metrics.bep.toFixed(1)} Bulan` : '-'} highlight />
              </div>
            </div>

            {/* Mini P&L */}
            <div className="bg-slate-800 text-white p-5 rounded-2xl shadow-lg">
              <h3 className="font-bold text-sm mb-4 opacity-90">Ringkasan Laba Rugi</h3>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between"><span>Pendapatan</span><span>{formatIDR(metrics.mRev)}</span></div>
                <div className="flex justify-between text-red-300"><span>HPP Bahan</span><span>({formatIDR(metrics.mCOGS)})</span></div>
                <div className="flex justify-between text-red-300"><span>Operasional</span><span>({formatIDR(metrics.expense)})</span></div>
                <div className="h-px bg-slate-600 my-2"></div>
                <div className="flex justify-between font-bold text-lg text-green-400"><span>Bersih</span><span>{formatIDR(metrics.net)}</span></div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'menu' && (
          <MobileList 
            title="Menu & HPP" 
            onAdd={() => add('menuItems', { name: 'Menu Baru', price: 0, cogs: 0, targetQty: 0 })}
          >
            {data.menuItems.map(item => (
              <Card key={item.id} onDelete={() => del('menuItems', item.id)}>
                <InputText val={item.name} onChange={(v) => updateArr('menuItems', item.id, 'name', v)} placeholder="Nama Menu" bold />
                <div className="grid grid-cols-3 gap-2 mt-3">
                  <InputNum label="Jual" val={item.price} onChange={(v) => updateArr('menuItems', item.id, 'price', v)} />
                  <InputNum label="HPP" val={item.cogs} onChange={(v) => updateArr('menuItems', item.id, 'cogs', v)} />
                  <InputNum label="Qty/Hari" val={item.targetQty} onChange={(v) => updateArr('menuItems', item.id, 'targetQty', v)} />
                </div>
              </Card>
            ))}
          </MobileList>
        )}

        {activeTab === 'sdm' && (
           <MobileList 
            title="SDM & Gaji" 
            onAdd={() => add('staff', { role: 'Posisi Baru', salary: 0, count: 1 })}
          >
            {data.staff.map(item => (
              <Card key={item.id} onDelete={() => del('staff', item.id)}>
                <InputText val={item.role} onChange={(v) => updateArr('staff', item.id, 'role', v)} placeholder="Jabatan" bold />
                <div className="grid grid-cols-2 gap-3 mt-3">
                  <InputNum label="Gaji/Orang" val={item.salary} onChange={(v) => updateArr('staff', item.id, 'salary', v)} />
                  <InputNum label="Jml Orang" val={item.count} onChange={(v) => updateArr('staff', item.id, 'count', v)} />
                </div>
              </Card>
            ))}
          </MobileList>
        )}

        {activeTab === 'cost' && (
          <div className="space-y-8">
            <MobileList 
              title="Modal Awal (Capex)" 
              onAdd={() => add('capex', { item: 'Investasi Baru', cost: 0 })}
            >
              {data.capex.map(item => (
                <Card key={item.id} onDelete={() => del('capex', item.id)}>
                  <InputText val={item.item} onChange={(v) => updateArr('capex', item.id, 'item', v)} placeholder="Nama Barang/Sewa" bold />
                  <div className="mt-2">
                    <InputNum label="Biaya" val={item.cost} onChange={(v) => updateArr('capex', item.id, 'cost', v)} />
                  </div>
                </Card>
              ))}
            </MobileList>

             <MobileList 
              title="Biaya Tetap (Opex)" 
              onAdd={() => add('opex', { item: 'Biaya Rutin', cost: 0 })}
            >
              {data.opex.map(item => (
                <Card key={item.id} onDelete={() => del('opex', item.id)}>
                  <InputText val={item.item} onChange={(v) => updateArr('opex', item.id, 'item', v)} placeholder="Nama Biaya" bold />
                  <div className="mt-2">
                    <InputNum label="Biaya per Bulan" val={item.cost} onChange={(v) => updateArr('opex', item.id, 'cost', v)} />
                  </div>
                </Card>
              ))}
            </MobileList>
          </div>
        )}

        {activeTab === 'profile' && (
          <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-4 animate-fade-in">
            <h2 className="font-bold text-lg mb-2">Profil Bisnis</h2>
            <div>
              <label className="text-xs text-slate-500 font-bold uppercase">Nama Usaha</label>
              <input type="text" value={data.profile.name} onChange={(e) => update('profile', {...data.profile, name: e.target.value})} className="w-full py-2 border-b border-slate-200 focus:border-orange-500 outline-none bg-transparent font-medium" placeholder="Nama Bisnis" />
            </div>
            <div>
              <label className="text-xs text-slate-500 font-bold uppercase">Tagline</label>
              <input type="text" value={data.profile.tagline} onChange={(e) => update('profile', {...data.profile, tagline: e.target.value})} className="w-full py-2 border-b border-slate-200 focus:border-orange-500 outline-none bg-transparent" placeholder="Slogan" />
            </div>
            <div>
              <label className="text-xs text-slate-500 font-bold uppercase">Pajak Restoran (%)</label>
              <div className="flex items-center gap-2">
                 <input type="number" step="0.1" value={data.profile.taxRate * 100} onChange={(e) => update('profile', {...data.profile, taxRate: parseFloat(e.target.value)/100})} className="w-20 py-2 border-b border-slate-200 focus:border-orange-500 outline-none bg-transparent font-mono" />
                 <span className="text-sm text-slate-400">%</span>
              </div>
            </div>
          </div>
        )}

      </main>

      {/* BOTTOM NAVIGATION BAR */}
      <nav className="bg-white border-t border-slate-200 fixed bottom-0 w-full pb-safe pt-2 px-2 flex justify-between items-center z-30 text-[10px] font-medium text-slate-400">
        <NavBtn id="dash" icon={LayoutDashboard} label="Dash" active={activeTab} set={setActiveTab} />
        <NavBtn id="menu" icon={UtensilsCrossed} label="Menu" active={activeTab} set={setActiveTab} />
        <NavBtn id="sdm" icon={Users} label="SDM" active={activeTab} set={setActiveTab} />
        <NavBtn id="cost" icon={Wallet} label="Biaya" active={activeTab} set={setActiveTab} />
        <NavBtn id="profile" icon={Store} label="Profil" active={activeTab} set={setActiveTab} />
      </nav>
    </div>
  );
}

// --- MOBILE COMPONENTS ---

function NavBtn({ id, icon: Icon, label, active, set }) {
  const isActive = active === id;
  return (
    <button 
      onClick={() => set(id)} 
      className={`flex flex-col items-center gap-1 p-2 w-full transition-colors ${isActive ? 'text-orange-600' : 'hover:text-slate-600'}`}
    >
      <Icon className={`w-6 h-6 ${isActive ? 'fill-orange-100' : ''}`} strokeWidth={isActive ? 2.5 : 2} />
      <span>{label}</span>
    </button>
  );
}

function StatCard({ label, val, icon: Icon, color }) {
  const colors = { blue: "text-blue-600 bg-blue-50", green: "text-green-600 bg-green-50", red: "text-red-500 bg-red-50" };
  return (
    <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col gap-2">
      <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${colors[color]}`}>
        <Icon className="w-5 h-5" />
      </div>
      <div>
        <p className="text-[10px] uppercase tracking-wider text-slate-400 font-semibold">{label}</p>
        <p className={`text-sm font-bold truncate ${colors[color].split(' ')[0]}`}>{val}</p>
      </div>
    </div>
  );
}

function HealthRow({ label, val, highlight }) {
  return (
    <div className="flex justify-between items-center text-sm border-b border-slate-50 pb-2 last:border-0 last:pb-0">
      <span className="text-slate-500">{label}</span>
      <span className={`font-medium ${highlight ? 'text-orange-600' : 'text-slate-800'}`}>{val}</span>
    </div>
  );
}

function MobileList({ title, children, onAdd }) {
  return (
    <div className="space-y-4 animate-fade-in">
      <div className="flex justify-between items-end px-1">
        <h2 className="font-bold text-lg text-slate-800">{title}</h2>
        <button onClick={onAdd} className="bg-slate-800 text-white p-2 rounded-lg shadow-lg active:scale-95 transition-transform">
          <Plus className="w-5 h-5" />
        </button>
      </div>
      <div className="space-y-3">
        {children}
      </div>
    </div>
  );
}

function Card({ children, onDelete }) {
  return (
    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 relative group">
      {children}
      <button onClick={onDelete} className="absolute top-3 right-3 text-slate-300 hover:text-red-500 p-2 -mr-2 -mt-2">
        <Trash2 className="w-4 h-4" />
      </button>
    </div>
  );
}

function InputText({ val, onChange, placeholder, bold }) {
  return (
    <input 
      type="text" 
      value={val} 
      onChange={(e) => onChange(e.target.value)} 
      placeholder={placeholder}
      className={`w-[85%] bg-transparent outline-none border-b border-transparent focus:border-orange-300 transition-colors pb-1 ${bold ? 'font-bold text-base text-slate-800' : 'text-sm text-slate-600'}`}
    />
  );
}

function InputNum({ label, val, onChange }) {
  return (
    <div className="bg-slate-50 rounded-lg px-2 py-1.5 border border-slate-100 focus-within:border-orange-400 focus-within:ring-1 focus-within:ring-orange-200 transition-all">
      <label className="block text-[9px] uppercase font-bold text-slate-400 mb-0.5">{label}</label>
      <input 
        type="number" 
        value={val} 
        onChange={(e) => onChange(parseFloat(e.target.value) || 0)} 
        className="w-full bg-transparent outline-none text-sm font-mono font-medium text-slate-700"
      />
    </div>
  );
}


