<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Outlet Rumah Kita + Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-closed { transform: translateX(-100%); }
        @media (min-width: 768px) { .sidebar-closed { transform: translateX(0); } }
        
        /* Toast Animation */
        .toast-enter { transform: translateX(100%); opacity: 0; }
        .toast-enter-active { transform: translateX(0); opacity: 1; transition: all 0.3s ease-out; }
        .toast-exit-active { transform: translateX(100%); opacity: 0; transition: all 0.3s ease-in; }

        /* Print Style */
        @media print {
            body * { visibility: hidden; }
            #receipt-preview, #receipt-preview * { visibility: visible; }
            #receipt-preview { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; box-shadow: none; }
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm p-8 rounded-2xl shadow-2xl text-center">
            <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-600 text-2xl font-bold">R</div>
            <h2 class="text-2xl font-bold mb-1">Admin Outlet</h2>
            <p class="text-slate-500 mb-6 text-sm">Rumah Kita</p>
            <input type="password" id="login-pin" placeholder="Masukkan PIN" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl mb-4 text-center text-lg tracking-widest outline-none focus:ring-2 focus:ring-orange-400">
            <button onclick="checkLogin()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 transition">Masuk</button>
        </div>
    </div>

    <!-- MOBILE HEADER -->
    <div class="md:hidden fixed top-0 left-0 right-0 bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4 z-40">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="w-10 h-10 flex items-center justify-center text-slate-600 active:bg-slate-100 rounded-lg"><i class="fas fa-bars text-xl"></i></button>
            <span class="font-bold text-lg">Admin Panel</span>
        </div>
        <button onclick="toggleCashierPanelMobile()" class="w-10 h-10 bg-orange-50 text-orange-600 rounded-lg flex items-center justify-center relative">
            <i class="fas fa-cash-register"></i>
        </button>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar" class="fixed top-0 bottom-0 left-0 w-64 bg-slate-900 text-white z-50 sidebar-closed md:transform-none flex flex-col pt-16 md:pt-0">
        <div class="h-16 flex items-center px-6 border-b border-white/10 hidden md:flex">
            <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center mr-3 font-bold">R</div>
            <span class="font-bold text-lg tracking-tight">Rumah Kita</span>
        </div>

        <div class="flex-1 overflow-y-auto py-4">
            <div class="px-4 mb-2 text-xs font-bold text-slate-500 uppercase tracking-wider">Menu Utama</div>
            <nav class="space-y-1 px-2">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition bg-white/10 text-white"><i class="fas fa-home w-5"></i> Dashboard</button>
                <button onclick="switchTab('orders')" id="nav-orders" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300 hover:bg-white/5 transition"><i class="fas fa-clipboard-list w-5"></i> Pesanan Masuk <span id="badge-orders" class="ml-auto bg-orange-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded hidden">0</span></button>
                <button onclick="switchTab('menu')" id="nav-menu" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300 hover:bg-white/5 transition"><i class="fas fa-utensils w-5"></i> Kelola Menu</button>
                <button onclick="switchTab('history')" id="nav-history" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300 hover:bg-white/5 transition"><i class="fas fa-history w-5"></i> Riwayat</button>
            </nav>
        </div>
        
        <div class="p-4 border-t border-white/10">
            <button onclick="logout()" class="w-full flex items-center gap-2 text-red-400 hover:text-red-300 text-sm font-bold px-2"><i class="fas fa-sign-out-alt"></i> Keluar</button>
        </div>
    </div>

    <!-- MOBILE OVERLAY BACKDROP -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden" onclick="closeAllPopups()"></div>

    <!-- MAIN CONTENT -->
    <main class="md:ml-64 min-h-screen pt-16 md:pt-0 transition-all duration-300">
        
        <!-- DASHBOARD VIEW -->
        <section id="view-dashboard" class="view-section p-4 md:p-8">
            <header class="flex justify-between items-end mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">Dashboard</h1>
                    <p class="text-slate-500 text-sm">Ringkasan hari ini</p>
                </div>
                <div class="text-right hidden md:block">
                    <div class="text-xs text-slate-400 font-bold uppercase">Status Toko</div>
                    <div class="flex items-center gap-2 text-green-600 font-bold"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> BUKA</div>
                </div>
            </header>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="text-slate-400 text-xs font-bold uppercase mb-1">Total Omset</div>
                    <div class="text-xl md:text-2xl font-bold text-slate-800" id="stat-omset">Rp 0</div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="text-slate-400 text-xs font-bold uppercase mb-1">Pesanan</div>
                    <div class="text-xl md:text-2xl font-bold text-slate-800" id="stat-orders">0</div>
                </div>
                 <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="text-slate-400 text-xs font-bold uppercase mb-1">Pending</div>
                    <div class="text-xl md:text-2xl font-bold text-orange-500" id="stat-pending">0</div>
                </div>
            </div>

            <!-- Bagian Kasir Manual -->
            <div class="flex flex-col md:flex-row gap-6 h-[calc(100vh-300px)]">
                <!-- List Menu (Kiri) -->
                <div class="flex-1 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col overflow-hidden">
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <h3 class="font-bold text-slate-700">Kasir Manual</h3>
                        <input type="text" id="search-pos" placeholder="Cari menu..." class="bg-white border border-slate-200 rounded-lg px-3 py-1.5 text-sm outline-none focus:border-orange-400 w-40 md:w-60">
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 grid grid-cols-2 lg:grid-cols-3 gap-3 content-start" id="pos-menu-grid">
                        <!-- Menu items render here -->
                    </div>
                </div>

                <!-- Panel Keranjang Kasir (Kanan - Hidden on Mobile initially) -->
                <div id="cashier-panel" class="fixed inset-x-0 bottom-0 bg-white z-[60] rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)] transform translate-y-full transition-transform duration-300 md:transform-none md:static md:w-96 md:rounded-2xl md:shadow-sm md:border md:border-slate-100 flex flex-col h-[85vh] md:h-auto">
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-3xl md:rounded-t-2xl">
                        <h3 class="font-bold text-slate-700">Keranjang</h3>
                        <button onclick="toggleCashierPanelMobile()" class="md:hidden text-slate-400"><i class="fas fa-times"></i></button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-4 space-y-3" id="pos-cart-items">
                        <div class="text-center text-slate-400 text-sm py-10">Keranjang kosong</div>
                    </div>

                    <div class="p-4 bg-slate-50 border-t border-slate-100">
                        <div class="flex justify-between text-sm mb-2"><span>Subtotal</span><span class="font-bold" id="pos-subtotal">Rp 0</span></div>
                        <div class="flex justify-between text-xl font-bold text-slate-800 mb-4"><span>Total</span><span id="pos-total">Rp 0</span></div>
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <input type="text" id="pos-cust-name" placeholder="Nama Pelanggan" class="col-span-2 px-3 py-2 text-sm border rounded-lg">
                            <select id="pos-payment" class="px-3 py-2 text-sm border rounded-lg bg-white">
                                <option value="CASH">Tunai</option>
                                <option value="QRIS">QRIS</option>
                                <option value="TF">Transfer</option>
                            </select>
                            <select id="pos-type" class="px-3 py-2 text-sm border rounded-lg bg-white">
                                <option value="Dine-In">Dine In</option>
                                <option value="Take-Away">Take Away</option>
                            </select>
                        </div>
                        <button onclick="processPosOrder()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 active:scale-95 transition">Bayar & Cetak</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ORDERS VIEW -->
        <section id="view-orders" class="view-section p-4 md:p-8 hidden">
            <h2 class="text-2xl font-bold mb-6">Pesanan Masuk (Online)</h2>
            <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" id="orders-list">
                <!-- Orders Render Here -->
                <div class="text-slate-400 col-span-full text-center py-20">Memuat pesanan...</div>
            </div>
        </section>

        <!-- MENU MANAGEMENT VIEW -->
        <section id="view-menu" class="view-section p-4 md:p-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Kelola Menu</h2>
                <button onclick="openMenuModal()" class="bg-orange-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg hover:bg-orange-600 transition"><i class="fas fa-plus mr-2"></i> Tambah</button>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 uppercase text-xs">
                        <tr>
                            <th class="px-6 py-4">Menu</th>
                            <th class="px-6 py-4">Harga</th>
                            <th class="px-6 py-4 text-center">Status</th>
                            <th class="px-6 py-4 text-right">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100" id="menu-table-body">
                        <!-- Table Rows Render Here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- HISTORY VIEW -->
        <section id="view-history" class="view-section p-4 md:p-8 hidden">
            <h2 class="text-2xl font-bold mb-6">Riwayat Transaksi</h2>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-4">Waktu</th>
                                <th class="px-6 py-4">Kode</th>
                                <th class="px-6 py-4">Pelanggan</th>
                                <th class="px-6 py-4">Tipe</th>
                                <th class="px-6 py-4">Total</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Cetak</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed top-5 right-5 z-[80] space-y-2"></div>

    <!-- MODAL ADD/EDIT MENU -->
    <div id="menu-modal" class="fixed inset-0 bg-black/60 z-[70] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl transform scale-95 transition-all">
            <h3 class="text-xl font-bold mb-4" id="modal-title">Tambah Menu</h3>
            <form id="menu-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Nama Menu</label>
                    <input type="text" id="inp-name" required class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-orange-400">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Harga</label>
                        <input type="number" id="inp-price" required class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-orange-400">
                    </div>
                     <div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Kategori</label>
                        <select id="inp-category" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none">
                            <option value="makanan">Makanan</option>
                            <option value="minuman">Minuman</option>
                            <option value="snack">Snack</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">URL Gambar (Opsional)</label>
                    <input type="text" id="inp-img" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-orange-400">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeMenuModal()" class="flex-1 py-2 text-slate-500 font-bold hover:bg-slate-50 rounded-lg">Batal</button>
                    <button type="submit" class="flex-1 bg-orange-500 text-white py-2 rounded-lg font-bold hover:bg-orange-600 shadow-lg shadow-orange-200">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- HIDDEN RECEIPT TEMPLATE (Untuk Print) -->
    <div id="receipt-preview" class="hidden bg-white p-4 max-w-[58mm] mx-auto text-xs font-mono leading-tight">
        <div class="text-center mb-2">
            <h2 class="font-bold text-sm uppercase">Rumah Kita</h2>
            <p>Outlet & Cafe</p>
            <p class="text-[10px] text-slate-500 mt-1" id="rec-date">Tgl: -</p>
            <p class="text-[10px] text-slate-500">ID: <span id="rec-id">-</span></p>
        </div>
        <hr class="border-dashed border-slate-300 my-2">
        <div id="rec-items" class="space-y-1"></div>
        <hr class="border-dashed border-slate-300 my-2">
        <div class="flex justify-between font-bold"><span>Total</span><span id="rec-total">0</span></div>
        <div class="flex justify-between text-[10px] mt-1"><span>Bayar</span><span id="rec-pay-method">-</span></div>
        <div class="flex justify-between text-[10px]" id="rec-cust-row"><span>Nama</span><span id="rec-cust">-</span></div>
        
        <!-- Tambahan Info Alamat di Struk (Opsional) -->
        <div id="rec-address-box" class="mt-2 pt-2 border-t border-dashed border-slate-300 hidden">
             <p class="font-bold underline">Alamat Antar:</p>
             <p id="rec-address-text" class="text-[10px] break-words"></p>
        </div>

        <div class="text-center mt-4 text-[10px] text-slate-400">
            <p>Terima Kasih!</p>
            <p>Simpan struk ini sebagai bukti.</p>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCVl_0OhaCKRiJ5-qPKwaoMs3q11tHRbys",
            authDomain: "outlet-rumah-kita.firebaseapp.com",
            projectId: "outlet-rumah-kita",
            storageBucket: "outlet-rumah-kita.firebasestorage.app",
            messagingSenderId: "1081923667869",
            appId: "1:1081923667869:web:797fce3cc6de79d2c69174"
        };
        const PIN_CODE = "123456"; // PIN LOGIN SEDERHANA

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const COL_MENU = 'cafe_menu';
        const COL_ORDERS = 'cafe_orders'; // Gabungan online & offline orders

        let menuList = [];
        let posCart = [];

        // --- AUTH SIMULASI ---
        window.checkLogin = () => {
            const pin = document.getElementById('login-pin').value;
            if(pin === PIN_CODE) {
                document.getElementById('login-overlay').classList.add('hidden');
                initApp();
            } else {
                alert("PIN Salah!");
            }
        }
        window.logout = () => location.reload();

        function initApp() {
            // Listen Menu
            onSnapshot(collection(db, COL_MENU), (snap) => {
                menuList = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderMenuTable();
                renderPosMenu();
            });

            // Listen Orders (Online & Offline)
            const q = query(collection(db, COL_ORDERS), orderBy('timestamp', 'desc'), limit(50));
            onSnapshot(q, (snap) => {
                const orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderOrdersList(orders);
                renderDashboardStats(orders);
                renderHistoryTable(orders);
            });
        }

        // --- RENDER FUNCTIONS ---
        function renderMenuTable() {
            const tbody = document.getElementById('menu-table-body');
            tbody.innerHTML = menuList.map(item => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 font-medium text-slate-800">${item.name}</td>
                    <td class="px-6 py-4 text-slate-600">Rp ${parseInt(item.price).toLocaleString()}</td>
                    <td class="px-6 py-4 text-center"><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">Aktif</span></td>
                    <td class="px-6 py-4 text-right space-x-2">
                        <button onclick="window.editMenu('${item.id}')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button>
                        <button onclick="window.deleteMenu('${item.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function renderPosMenu() {
            const grid = document.getElementById('pos-menu-grid');
            const term = document.getElementById('search-pos').value.toLowerCase();
            const filtered = menuList.filter(m => m.name.toLowerCase().includes(term));
            
            grid.innerHTML = filtered.map(item => `
                <div onclick="window.addToPosCart('${item.id}')" class="bg-white border border-slate-100 p-3 rounded-xl cursor-pointer hover:border-orange-400 transition group">
                    <div class="h-24 bg-slate-50 rounded-lg mb-2 overflow-hidden">
                         <img src="${item.imageUrl || `https://placehold.co/200x200/fff7ed/fdba74?text=${item.name.charAt(0)}`}" class="w-full h-full object-cover group-hover:scale-110 transition">
                    </div>
                    <div class="font-bold text-sm text-slate-800 line-clamp-1">${item.name}</div>
                    <div class="text-xs text-orange-500 font-bold">Rp ${parseInt(item.price).toLocaleString()}</div>
                </div>
            `).join('');
        }

        // --- FUNGSI UTAMA: RENDER PESANAN ONLINE (DENGAN PETA) ---
        function renderOrdersList(orders) {
            // Filter hanya yang statusnya bukan 'completed' atau 'cancelled' untuk tab Pesanan Masuk
            // Atau tampilkan semua tapi yang 'pending' ditaruh paling atas
            const activeOrders = orders.filter(o => o.status !== 'completed' && o.source === 'online');
            const list = document.getElementById('orders-list');
            
            document.getElementById('badge-orders').innerText = activeOrders.filter(o=>o.status==='pending').length;
            document.getElementById('badge-orders').classList.toggle('hidden', activeOrders.filter(o=>o.status==='pending').length === 0);

            if(activeOrders.length === 0) {
                list.innerHTML = '<div class="col-span-full text-center text-slate-400 py-10">Tidak ada pesanan aktif.</div>';
                return;
            }

            list.innerHTML = activeOrders.map(o => {
                let statusColor = 'bg-slate-100 text-slate-500';
                if(o.status === 'pending') statusColor = 'bg-orange-100 text-orange-600 animate-pulse';
                if(o.status === 'confirmed') statusColor = 'bg-blue-100 text-blue-600';
                if(o.status === 'ready') statusColor = 'bg-green-100 text-green-600';

                // --- LOGIKA TOMBOL PETA ---
                let mapButtonHtml = '';
                let distanceHtml = '';
                
                // Cek apakah ada data lokasi (lat/lng)
                if (o.location && o.location.lat && o.location.lng) {
                    // Link Google Maps Direct
                    const googleMapsUrl = `https://www.google.com/maps?q=${o.location.lat},${o.location.lng}`;
                    
                    mapButtonHtml = `
                        <a href="${googleMapsUrl}" target="_blank" class="mt-3 block w-full bg-blue-50 text-blue-600 text-center py-2 rounded-lg text-xs font-bold hover:bg-blue-100 border border-blue-200 transition flex items-center justify-center gap-2">
                            <i class="fas fa-map-marked-alt"></i> üìç Lihat Lokasi Pelanggan
                        </a>
                    `;
                    
                    if(o.location.distance) {
                        distanceHtml = `<span class="bg-slate-200 px-1.5 rounded text-[10px] ml-2 text-slate-600"><i class="fas fa-road"></i> ${o.location.distance} km</span>`;
                    }
                }

                // Format Harga Total & Ongkir
                const subtotal = o.subtotal || 0;
                const fee = o.deliveryFee || 0;
                const total = subtotal + fee;

                return `
                <div class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm relative overflow-hidden">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="font-bold text-lg text-slate-800">${o.queueCode}</span>
                            <div class="text-xs text-slate-400">${new Date(o.timestamp?.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                        </div>
                        <span class="px-2 py-1 rounded text-xs font-bold uppercase ${statusColor}">${o.status}</span>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center gap-2 text-sm text-slate-700">
                            <i class="fas fa-user w-4 text-center text-slate-400"></i> <span class="font-bold">${o.customerName}</span>
                        </div>
                         <div class="flex items-center gap-2 text-sm text-slate-700">
                            <i class="fab fa-whatsapp w-4 text-center text-green-500"></i> 
                            <a href="https://wa.me/${o.customerPhone}" target="_blank" class="hover:underline">${o.customerPhone}</a>
                        </div>
                        <div class="flex items-start gap-2 text-xs text-slate-500 bg-slate-50 p-2 rounded">
                            <i class="fas fa-map-marker-alt w-4 mt-0.5 text-center text-orange-400"></i>
                            <div>
                                <p>${o.address || 'Alamat tidak diisi'}</p>
                                ${distanceHtml}
                            </div>
                        </div>
                        ${mapButtonHtml} <!-- TOMBOL MAP DISINI -->
                    </div>

                    <div class="border-t border-slate-100 pt-3 mb-4 space-y-1">
                        ${o.items.map(i => `<div class="flex justify-between text-xs text-slate-600"><span>${i.qty}x ${i.name}</span><span>${(i.price*i.qty).toLocaleString()}</span></div>`).join('')}
                        ${fee > 0 ? `<div class="flex justify-between text-xs text-slate-500 italic mt-1 pt-1 border-t border-dashed"><span>Ongkir</span><span>${fee.toLocaleString()}</span></div>` : ''}
                        <div class="flex justify-between font-bold text-sm text-slate-800 pt-2 border-t border-slate-100 mt-2"><span>Total (${o.paymentMethod})</span><span>Rp ${total.toLocaleString()}</span></div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        ${o.status === 'pending' ? `
                            <button onclick="window.updateStatus('${o.id}', 'confirmed')" class="bg-blue-500 text-white py-2 rounded-lg text-xs font-bold hover:bg-blue-600">Terima</button>
                            <button onclick="window.updateStatus('${o.id}', 'cancelled')" class="bg-red-50 text-red-500 py-2 rounded-lg text-xs font-bold hover:bg-red-100">Tolak</button>
                        ` : ''}
                        ${o.status === 'confirmed' ? `
                            <button onclick="window.printReceipt('${o.id}')" class="bg-slate-100 text-slate-600 py-2 rounded-lg text-xs font-bold hover:bg-slate-200"><i class="fas fa-print"></i> Struk</button>
                            <button onclick="window.updateStatus('${o.id}', 'completed')" class="bg-green-500 text-white py-2 rounded-lg text-xs font-bold hover:bg-green-600">Selesai</button>
                        ` : ''}
                         ${o.status === 'completed' ? `
                            <button onclick="window.printReceipt('${o.id}')" class="col-span-2 bg-slate-100 text-slate-600 py-2 rounded-lg text-xs font-bold hover:bg-slate-200"><i class="fas fa-print"></i> Cetak Ulang Struk</button>
                        ` : ''}
                    </div>
                </div>
                `.trim();
            }).join('');
        }

        function renderHistoryTable(orders) {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = orders.map(o => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 text-slate-500">${new Date(o.timestamp?.seconds*1000).toLocaleDateString()}</td>
                    <td class="px-6 py-4 font-bold text-slate-800">${o.queueCode || '-'}</td>
                    <td class="px-6 py-4 text-slate-600">${o.customerName || 'Umum'}</td>
                    <td class="px-6 py-4"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold">${o.source==='online'?'WEB':'KASIR'}</span></td>
                    <td class="px-6 py-4 font-bold text-slate-800">Rp ${parseInt(o.total).toLocaleString()}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${o.status==='completed'?'bg-green-100 text-green-600':'bg-slate-100 text-slate-500'}">${o.status}</span></td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="window.printReceipt('${o.id}')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-print"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function renderDashboardStats(orders) {
            // Filter hari ini
            const today = new Date().toDateString();
            const todayOrders = orders.filter(o => new Date(o.timestamp?.seconds*1000).toDateString() === today);
            
            const omset = todayOrders.filter(o=>o.status!=='cancelled').reduce((a,b) => a + (b.total || 0), 0);
            const count = todayOrders.length;
            const pending = todayOrders.filter(o => o.status === 'pending').length;

            document.getElementById('stat-omset').innerText = `Rp ${omset.toLocaleString()}`;
            document.getElementById('stat-orders').innerText = count;
            document.getElementById('stat-pending').innerText = pending;
        }

        // --- POS CART LOGIC ---
        window.addToPosCart = (id) => {
            const item = menuList.find(m => m.id === id);
            const exist = posCart.find(c => c.id === id);
            if(exist) exist.qty++; else posCart.push({...item, qty:1});
            renderPosCart();
        }
        window.posQty = (id, delta) => {
            const idx = posCart.findIndex(c => c.id === id);
            if(idx > -1) { posCart[idx].qty += delta; if(posCart[idx].qty <= 0) posCart.splice(idx,1); renderPosCart(); }
        }
        function renderPosCart() {
            const el = document.getElementById('pos-cart-items');
            if(posCart.length === 0) { el.innerHTML = '<div class="text-center text-slate-400 text-sm py-10">Keranjang kosong</div>'; document.getElementById('pos-total').innerText='Rp 0'; document.getElementById('pos-subtotal').innerText='Rp 0'; return; }
            
            let total = 0;
            el.innerHTML = posCart.map(item => {
                total += item.price * item.qty;
                return `
                <div class="flex justify-between items-center text-sm">
                    <div>
                        <div class="font-bold text-slate-700">${item.name}</div>
                        <div class="text-xs text-slate-500">@ ${parseInt(item.price).toLocaleString()}</div>
                    </div>
                    <div class="flex items-center gap-2 bg-slate-100 rounded-lg p-1">
                        <button onclick="window.posQty('${item.id}', -1)" class="w-6 h-6 bg-white shadow rounded flex items-center justify-center font-bold text-slate-600">-</button>
                        <span class="w-4 text-center font-bold text-slate-800">${item.qty}</span>
                        <button onclick="window.posQty('${item.id}', 1)" class="w-6 h-6 bg-slate-800 text-white shadow rounded flex items-center justify-center font-bold">+</button>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('pos-subtotal').innerText = 'Rp ' + total.toLocaleString();
            document.getElementById('pos-total').innerText = 'Rp ' + total.toLocaleString();
        }

        // --- PROCESS POS ORDER ---
        window.processPosOrder = async () => {
            if(posCart.length === 0) return alert("Keranjang kosong!");
            
            const total = posCart.reduce((a,b) => a+(b.price*b.qty), 0);
            const name = document.getElementById('pos-cust-name').value || 'Pelanggan Walk-in';
            const pay = document.getElementById('pos-payment').value;
            const type = document.getElementById('pos-type').value;

            // Generate Kode Antrian Offline (A-...)
            const code = `A-${Math.floor(Math.random()*1000)}`;

            try {
                const docRef = await addDoc(collection(db, COL_ORDERS), {
                    customerName: name, items: posCart, total: total,
                    paymentMethod: pay, orderType: type, source: 'offline',
                    status: 'completed', timestamp: serverTimestamp(), queueCode: code
                });
                
                // Langsung Print Struk
                printReceiptInternal({
                    id: docRef.id, queueCode: code, customerName: name,
                    items: posCart, total: total, paymentMethod: pay, 
                    timestamp: {seconds: Date.now()/1000}
                });

                posCart = []; renderPosCart(); document.getElementById('pos-cust-name').value = '';
                showToast("Pesanan Kasir Sukses!", 'success');
            } catch(e) { alert("Gagal proses: " + e.message); }
        }

        // --- ACTIONS ---
        window.updateStatus = async (id, status) => {
            if(!confirm(`Ubah status jadi ${status}?`)) return;
            await updateDoc(doc(db, COL_ORDERS, id), { status: status });
            showToast(`Status diubah: ${status}`);
        }

        // --- PRINTING LOGIC ---
        window.printReceipt = async (id) => {
            // Ambil data order dari list yang ada di memory (agak hacky tapi cepat)
            // Idealnya fetch doc by id, tapi karena kita subscribe real-time, data di UI sudah ada
            // Kita fetch ulang saja biar aman
            // Tapi disini saya pakai cara simple cari di DOM element atau fetch one time
            // Kita pakai listener orders yang sudah ada di memory scope 'renderOrdersList' tidak bisa diakses langsung
            // Jadi kita fetch one time doc
            
            // Cari data di local snapshot (kalau mau complex), tapi fetch doc simple:
             // Note: Module scope issues. 
        }

        // Override printReceipt agar bisa baca DB
        window.printReceipt = (id) => {
            // Karena ini module, kita listen click event atau passing object susah. 
            // Kita ambil data dari Firestore langsung by ID
            // Tapi karena firebase v9 modular, kita buat helper internal
             getDocAndPrint(id);
        }

        import { getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        async function getDocAndPrint(id) {
            const sn = await getDoc(doc(db, COL_ORDERS, id));
            if(sn.exists()) {
                printReceiptInternal({id: sn.id, ...sn.data()});
            }
        }

        function printReceiptInternal(data) {
            document.getElementById('rec-id').innerText = data.queueCode || data.id.substr(0,6);
            document.getElementById('rec-date').innerText = new Date(data.timestamp?.seconds*1000).toLocaleString();
            document.getElementById('rec-cust').innerText = data.customerName;
            document.getElementById('rec-pay-method').innerText = data.paymentMethod;
            document.getElementById('rec-total').innerText = 'Rp ' + parseInt(data.total).toLocaleString();

            const itemsDiv = document.getElementById('rec-items');
            itemsDiv.innerHTML = data.items.map(i => 
                `<div class="flex justify-between"><span>${i.qty} ${i.name}</span><span>${(i.price*i.qty).toLocaleString()}</span></div>`
            ).join('');

            if(data.deliveryFee) {
                 itemsDiv.innerHTML += `<div class="flex justify-between italic text-slate-500"><span>Ongkir</span><span>${data.deliveryFee.toLocaleString()}</span></div>`;
            }

            // Tampilkan Alamat di Struk jika ada
            const addrBox = document.getElementById('rec-address-box');
            if(data.address) {
                addrBox.classList.remove('hidden');
                document.getElementById('rec-address-text').innerText = data.address + (data.location?.distance ? ` (${data.location.distance} km)` : '');
            } else {
                addrBox.classList.add('hidden');
            }

            setTimeout(() => window.print(), 500);
        }

        // --- MENU CRUD ---
        window.openMenuModal = () => { document.getElementById('menu-form').reset(); document.getElementById('edit-id').value=''; document.getElementById('modal-title').innerText='Tambah Menu'; document.getElementById('menu-modal').classList.remove('hidden'); document.getElementById('menu-modal').classList.add('flex'); }
        window.closeMenuModal = () => { document.getElementById('menu-modal').classList.add('hidden'); document.getElementById('menu-modal').classList.remove('flex'); }
        
        window.editMenu = (id) => {
            const item = menuList.find(m => m.id === id);
            if(!item) return;
            document.getElementById('edit-id').value = id;
            document.getElementById('inp-name').value = item.name;
            document.getElementById('inp-price').value = item.price;
            document.getElementById('inp-img').value = item.imageUrl || '';
            document.getElementById('inp-category').value = item.category || 'makanan';
            document.getElementById('modal-title').innerText='Edit Menu';
            document.getElementById('menu-modal').classList.remove('hidden');
            document.getElementById('menu-modal').classList.add('flex');
        }

        document.getElementById('menu-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = {
                name: document.getElementById('inp-name').value,
                price: parseInt(document.getElementById('inp-price').value),
                category: document.getElementById('inp-category').value,
                imageUrl: document.getElementById('inp-img').value
            };
            
            if(id) await updateDoc(doc(db, COL_MENU, id), data);
            else await addDoc(collection(db, COL_MENU), data);
            
            closeMenuModal(); showToast("Menu Tersimpan", 'success');
        });

        window.deleteMenu = async (id) => {
            if(confirm("Hapus menu ini?")) {
                await deleteDoc(doc(db, COL_MENU, id));
                showToast("Menu Dihapus");
            }
        }

        // --- UTILS ---
        function showToast(msg, type='info') {
            const box = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `bg-slate-800 text-white px-4 py-3 rounded-xl shadow-lg text-sm font-bold flex items-center gap-2 toast-enter`;
            el.innerHTML = `<i class="fas fa-info-circle text-orange-400"></i> ${msg}`;
            box.appendChild(el);
            
            requestAnimationFrame(() => {
                 el.classList.remove('toast-enter');
                 el.classList.add('toast-enter-active');
            });

            setTimeout(() => {
                el.classList.remove('toast-enter-active');
                el.classList.add('toast-exit-active');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // Search Listener for POS
        document.getElementById('search-pos').addEventListener('input', renderPosMenu);
    </script>

    <script>
        // UI INTERACTION (Non-Module)
        function toggleSidebar() { 
            const sb = document.getElementById('sidebar'); 
            const ov = document.getElementById('mobile-overlay');
            sb.classList.toggle('sidebar-closed'); 
            ov.classList.toggle('hidden'); 
        }
        
        function closeAllPopups() {
            const sb = document.getElementById('sidebar'); 
            const ov = document.getElementById('mobile-overlay'); 
            const cashierPanel = document.getElementById('cashier-panel');
            
            if (!sb.classList.contains('sidebar-closed') && window.innerWidth < 768) {
                sb.classList.add('sidebar-closed');
            }
            // Close cashier panel mobile
            if (!cashierPanel.classList.contains('translate-y-full') && window.innerWidth < 768) {
                 cashierPanel.classList.add('translate-y-full');
            }
            if(!ov.classList.contains('hidden')) ov.classList.add('hidden');
        }

        window.toggleCashierPanelMobile = () => {
            const sb = document.getElementById('sidebar'); 
            const ov = document.getElementById('mobile-overlay'); 
            const cashierPanel = document.getElementById('cashier-panel');

            // Jika sidebar terbuka, tutup dulu
            if (!sb.classList.contains('sidebar-closed')) {
                sb.classList.add('sidebar-closed');
            }

            // Lakukan toggle untuk panel kasir & overlay
            cashierPanel.classList.toggle('translate-y-full'); 
            ov.classList.toggle('hidden');
        }
        
        window.switchTab = (id) => { 
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden')); 
            document.getElementById('view-'+id).classList.remove('hidden'); 
            document.querySelectorAll('.nav-item').forEach(e => { 
                e.classList.remove('bg-white/10', 'text-white'); 
                e.classList.add('text-slate-300'); 
            }); 
            document.getElementById('nav-'+id).classList.add('bg-white/10', 'text-white'); 
            
            // Jika pindah tab, selalu tutup popup
            if(window.innerWidth < 768) {
                closeAllPopups();
            } 
        }
        
        switchTab('dashboard');
    </script>
</body>
</html>

